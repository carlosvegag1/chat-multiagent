# ===============================
# 🧱 Etapa base: Backend FastAPI + Whisper
# ===============================
FROM python:3.12-slim

# Directorio de trabajo
WORKDIR /app

# -------------------------------
# 🔧 Dependencias del sistema
# -------------------------------
RUN apt-get update && apt-get install -y \
    ffmpeg \
    git \
    curl \
    && rm -rf /var/lib/apt/lists/*

# -------------------------------
# 📦 Instalar dependencias Python
# -------------------------------
COPY backend/requirements.txt /app/requirements.txt
RUN pip install --no-cache-dir -r requirements.txt

# -------------------------------
# 🧠 Soporte para Whisper (PyTorch CPU)
# -------------------------------
# Incluimos Whisper y Torch explícitamente (a veces Whisper no instala Torch automáticamente)
RUN pip install --no-cache-dir openai-whisper torch pydub

# -------------------------------
# 📂 Copiar código del backend
# -------------------------------
COPY backend /app

# -------------------------------
# 🔧 Variables de entorno
# -------------------------------
ENV CALC_SERVER_URL=http://calc:8770
ENV FLIGHT_SERVER_URL=http://flights:8771
ENV HOTEL_SERVER_URL=http://hotels:8772
ENV DESTINATION_SERVER_URL=http://destinations:8773
ENV OPENAI_API_KEY=""
ENV PYTHONUNBUFFERED=1
ENV UVICORN_WORKERS=1

# -------------------------------
# 🚀 Puerto y comando
# -------------------------------
EXPOSE 8000
CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]
